<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% load static %}

  {% block title %}
  <title>å®˜æ–¹ç¶²ç«™ï½œGG SHOP</title>
  {% endblock title %}

  <!-- favicon -->
  <link rel="icon" href="{% static 'GGicon.png' %}" type="image/png">

  <!-- Bootstrapï¼ˆå…¨ç«™ä¸€æ¬¡ï¼‰ -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- å…¨ç«™ CSS -->
  <link rel="stylesheet" href="{% static 'css/body.css' %}">
  <link rel="stylesheet" href="{% static 'css/arrow.css' %}">
  <link rel="stylesheet" href="{% static 'css/menu.css' %}">
  <link rel="stylesheet" href="{% static 'css/member.css' %}">
  <link rel="stylesheet" href="{% static 'css/footer.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <!-- icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

  {% block head %}{% endblock head %}

  <!-- carousel å°ˆç”¨ -->
  <style>
    .carousel-inner img {
      height: 600px;
      object-fit: contain;
    }
  </style>
</head>

<body class="site">

  <!-- ================= HEADER ================= -->
  <header class="header">
  <div class="header-top">
    <div class="logo">
      <a href="/GGshopping/">GG SHOP</a>
    </div>
    <div class="top-right-icons">
      <div id="member-area">
        <a href="/login/" id="login-btn">
          <img src="{% static 'member.jpg' %}" width="35" alt="ç™»å…¥">
        </a>
      </div>
        <a href="/cart/" class="cart-icon position-relative">
          <img src="{% static 'shopping-cart.jpg' %}" width="35" alt="è³¼ç‰©è»Š">
          <span id="cart-badge" class="cart-badge d-none">0</span>
        </a>
    </div>
  </div>
   <nav>
      <ul class="menu">
        <li><a href="/news/">NEWS</a></li>
        <li><a href="/shop/">SHOP</a></li>
        <li><a href="/about/">ABOUT</a></li>
        <li><a href="/contact/">CONTACT</a></li>
      </ul>
    </nav>
</header>
  <!-- ================= æ–°æœƒå“¡ Banner ================= -->
  {% block top_banner %}
    <div class="newmember">
        <img src="{% static 'newmember.jpg' %}">
    </div>
  {% endblock top_banner %}
  <!-- ================= MAIN CONTENT ================= -->
  <main class="content">
    {% block content %}

    <!-- é è¨­é¦–é  Carouselï¼ˆåªæœ‰é¦–é æœƒç”¨ï¼Œå…¶ä»–é æœƒè¦†è“‹ï¼‰ -->
    <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner">

        <div class="carousel-item active">
          <img src="{% static 'products/puma.jpg' %}" class="d-block w-100" alt="Puma">
        </div>

        <div class="carousel-item">
          <img src="{% static 'products/nike.jpg' %}" class="d-block w-100" alt="Nike">
        </div>

        <div class="carousel-item">
          <img src="{% static 'products/adidas.jpg' %}" class="d-block w-100" alt="Adidas">
        </div>

      </div>

      <button class="carousel-control-prev" type="button"
        data-bs-target="#carouselExampleControls" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>

      <button class="carousel-control-next" type="button"
        data-bs-target="#carouselExampleControls" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>

    {% endblock content %}
  </main>

  <!-- ================= FOOTER ================= -->
  <footer class="footer-copyright">
    <div class="footer-width">
      <p>Copyright Â© GGSHOP | All Rights Reserved</p>
    </div>
  </footer>

  <!-- å›é ‚éƒ¨ -->
  <div class="arrow">
    <a href="#" title="Back to Top">
      <span class="fas fa-angle-up"></span>
    </a>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQIC_jH4wQguSTnvmy2gdl3TyJcO-lXME",
      authDomain: "shopping-54704.firebaseapp.com",
      projectId: "shopping-54704",
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>

  <script>
    auth.onAuthStateChanged(async (user) => {
      const memberArea = document.getElementById("member-area");
      const badge = document.getElementById("cart-badge");

      if (user) {
        const uid = user.uid;
        const userData = {
          uid: uid,
          email: user.email || "",
          name: user.displayName || "",  
          provider: user.providerData.map(p => p.providerId).join(","),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

      
        const ref = firebase.firestore().collection("users").doc(uid);
        const snap = await ref.get();

        if (!snap.exists) {
          // ç¬¬ä¸€æ¬¡ç™»å…¥æ‰å»ºç«‹
          await ref.set(userData);
        } else {
          // åªæ›´æ–° email / providerï¼Œä¸å‹• name
          await ref.set({
            email: user.email || "",
            provider: user.providerData.map(p => p.providerId).join(","),
          }, { merge: true });
        };

        const data = snap.exists ? snap.data() : userData;

        memberArea.innerHTML = `
          <div class="member-menu">
            <span id="member-toggle" class="welcome-text">
              ğŸ‘‹ ${ data.name || data.email } â–¾
            </span>

            <div id="member-dropdown" class="member-dropdown d-none">
              <a href="/profile/">æˆ‘çš„å¸³æˆ¶</a>
              <a href="/orders/">è³¼è²·ç´€éŒ„</a>
              <a href="/favorites/">æˆ‘çš„æœ€æ„›</a>
              <a href="#" id="logout-btn">ç™»å‡º</a>
            </div>
          </div>
        `;
        const toggle = document.getElementById("member-toggle");
        const dropdown = document.getElementById("member-dropdown");
        toggle.onclick = () => {
          dropdown.classList.toggle("d-none");
        };
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".member-menu")) {
            dropdown.classList.add("d-none");
          }
        });

        document.getElementById("logout-btn").onclick = async () => {
          auth.signOut();window.location.href = "/login/";
        }
        updateCartBadge();
      
      } else {
        memberArea.innerHTML = `
          <a href="/login/">
            <img src="{% static 'member.jpg' %}" width="35" alt="ç™»å…¥">
          </a>
        `;

        document.getElementById("cart-badge").classList.add("d-none");
      }
    });
  </script>
  <script>
    async function updateCartBadge() {
      try {
        const user = firebase.auth().currentUser;
        if (!user) return;

        const token = await user.getIdToken();

        const res = await fetch("/api/cart/", {
          headers: {
            Authorization: "Bearer " + token
          }
        });

        if (!res.ok) return;

        const cart = await res.json();
        const badge = document.getElementById("cart-badge");
        if (!badge) return;

        if (cart.length > 0) {
          const totalQty = cart.reduce(
            (sum, item) => sum + item.quantity,
            0
          );
          badge.classList.remove("d-none");
          badge.innerText = totalQty;
        } else {
          badge.classList.add("d-none");
        }
      } catch (err) {
        console.error("æ›´æ–°è³¼ç‰©è»Šæ•¸é‡å¤±æ•—", err);
      }
    }
    </script>

  {% block extra_js %}{% endblock extra_js %}
</body>
</html>
