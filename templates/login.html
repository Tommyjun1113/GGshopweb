{% extends "GGshopping.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/login.css' %}">
{% endblock head %}

{% block content %}
<div class="login-container">

    {% if messages %}
      {% for message in messages %}
        <div class="msg {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    
    <div id="loginBox" class="form-box active">
        <h1 class="login-title">登入</h1>
        <div id="login-error" class="login-error"></div>
       <form id="login-form" onsubmit="return false;">
            {% csrf_token %}

            <input
                class="login-input"
                type="text"
                name="account"
                placeholder="請輸入帳號"
                required
            >

            <input
                class="login-input"
                type="password"
                name="password"
                placeholder="請輸入密碼（至少6位）"
                minlength="6"
                required
            >

            <button class="login-btn" id="email-login-btn" type="button">
                登入
            </button>
        </form>

        <div class="forgot-password" type="button" onclick="goToForgotStep1()">
            忘記密碼？
        </div>

        <div class="divider">或使用社群帳號登入</div>

        <div class="social-login">
            <button class="social-btn line" type="button">
                <img src="{% static 'icons/line.svg' %}">
            </button>
            <button id="google-login-btn" class="social-btn" type="button" >
                <img src="{% static 'icons/google.svg' %}">
            </button>
        </div>

        <div class="register-section">
            <h3>還不是會員？</h3>
            <button class="register-btn" type="button" onclick="goToreRisterStep1()">
                註冊會員
            </button>
        </div>
    </div>

    
    <div id="registerBox" class="form-box">

        <!-- 註冊 Step 1 -->
        <div id="registerStep1" class="form-step active">
            <h1 class="login-title">註冊會員</h1>

            <input class="login-input" type="text" id="regPhone" placeholder="手機號碼" required>
            <input class="login-input" type="email" id="regEmail" placeholder="Email" required>

            <button class="login-btn" type="button" onclick="goRegisterStep2()">
                下一步
            </button>

            <div class="register-section">
                <h3>已經有帳號？</h3>
                <button class="register-btn" type="button" onclick="switchToLogin()">
                    登入
                </button>
            </div>
        </div>

        <!-- 註冊 Step 2 -->
        <div id="registerStep2" class="form-step">
            <h1 class="login-title">設定密碼</h1>

            <form id="register-form" onsubmit="return false;">
                {% csrf_token %}
                <input class="login-input" name="password" type="password" placeholder="設定密碼(至少6位數)" minlength="6" required>
                <input class="login-input" name="password2" type="password" placeholder="確認密碼(至少6位數)" minlength="6" required>

                <button class="login-btn" id="register-btn" type="button">完成註冊</button>
            </form>
        </div>
    </div>

    
    <div id="forgotBox" class="form-box">

        <!-- 忘記密碼 Step 1 -->
        <div id="forgotStep1" class="form-step active">
            <h1 class="login-title">忘記密碼</h1>

            <input class="login-input" id="forgotAccount" placeholder="請輸入 Email 或手機">

            <button class="login-btn" id="forgot-btn" type="button">
                發送驗證碼
            </button>

            <div class="forgot-password" type="button" onclick="switchToLogin()">
                ← 返回登入
            </div>
        </div>

        <!-- 忘記密碼 Step 2 -->
        <div id="forgotStep2" class="form-step">
            <h1 class="login-title">輸入驗證碼</h1>

            <input class="login-input" id="forgotCode" placeholder="驗證碼">

            <button class="login-btn" id="forgot-confirm-btn">驗證</button>
        </div>

        <!-- 忘記密碼 Step 3 -->
        <div id="resetPasswordBox" class="form-step">
            <h1 class="login-title">重設密碼</h1>

            <input class="login-input" id="newPwd" type="password" placeholder="新密碼">
            <input class="login-input" id="newPwd2" type="password" placeholder="確認新密碼">

            <button class="login-btn" id="reset-password-btn">確認重設</button>
        </div>
    </div>
</div>
{% endblock content %}
{% block extra_js %}
<meta name="csrf-token" content="{{ csrf_token }}">
<script src="{% static 'js/auth-utils.js' %}"></script>
<script src="{% static 'js/login.js' %}"></script>
<script src="{% static 'js/register.js' %}"></script>
<script src="{% static 'js/forgot.js' %}"></script>

<script>
function showError(id, message) {
  const box = document.getElementById(id);
  if (!box) return;
  box.innerText = message;
  box.style.display = "flex";
}

function hideError(id) {
  const box = document.getElementById(id);
  if (!box) return;
  box.innerText = "";
  box.style.display = "none";
}

function firebaseErrorToMessage(err) {
  switch (err.code) {
    case "auth/user-not-found":
      return "此帳號尚未註冊";
    case "auth/wrong-password":
      return "密碼錯誤，請重新輸入";
    case "auth/invalid-email":
      return "Email 格式錯誤";
    case "auth/email-already-in-use":
      return "此 Email 已被註冊";
    case "auth/weak-password":
      return "密碼強度不足（至少 6 碼）";
    case "auth/invalid-credential":
      return "帳號或密碼錯誤";
    case "auth/operation-not-allowed": 
      return "Firebase 未啟用 Google 登入";
    case "auth/unauthorized-domain": 
      return "此網域未在 Firebase 授權清單中";
    case "auth/popup-closed-by-user": 
      return "登入視窗已被關閉";
    case "auth/popup-closed-by-user":
      return "登入視窗已被關閉，請重新點擊並完成登入。";
    case "auth/popup-blocked":
      return "請允許瀏覽器彈出視窗，以進行 Google 登入。";
    default:
      return "操作失敗，請稍後再試";
  }
}
</script>

<script>
function hideAllBoxes() {
  document.querySelectorAll(".form-box, .form-step").forEach(el => {
    el.classList.remove("active");
  });
}
function switchToLogin() {
  hideAllBoxes();
  document.getElementById("loginBox").classList.add("active");
}


function goToreRisterStep1() {
  hideAllBoxes();
  document.getElementById("registerBox").classList.add("active");
  document.getElementById("registerStep1").classList.add("active");
}

function goRegisterStep2() {
  document.getElementById("registerStep1").classList.remove("active");
  document.getElementById("registerStep2").classList.add("active");
}


function goToForgotStep1() {
  hideAllBoxes();
  document.getElementById("forgotBox").classList.add("active");
  document.getElementById("forgotStep1").classList.add("active");
}
</script>
{% endblock %}