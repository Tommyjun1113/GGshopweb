{% extends "GGshopping.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/login.css' %}">
{% endblock head %}

{% block content %}
<div class="login-container">

    {% if messages %}
      {% for message in messages %}
        <div class="msg {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- ================= ç™»å…¥ ================= -->
    <div id="loginBox" class="form-box active">
        <h1 class="login-title">ç™»å…¥</h1>
        <div id="login-error" class="login-error"></div>
       <form id="login-form" onsubmit="return false;">
            {% csrf_token %}

            <input
                class="login-input"
                type="text"
                name="account"
                placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"
                required
            >

            <input
                class="login-input"
                type="password"
                name="password"
                placeholder="è«‹è¼¸å…¥å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰"
                minlength="6"
                required
            >

            <button class="login-btn" id="email-login-btn" type="button">
                ç™»å…¥
            </button>
        </form>

        <div class="forgot-password" type="button" onclick="goToForgotStep1()">
            å¿˜è¨˜å¯†ç¢¼ï¼Ÿ
        </div>

        <div class="divider">æˆ–ä½¿ç”¨ç¤¾ç¾¤å¸³è™Ÿç™»å…¥</div>

        <div class="social-login">
            <button class="social-btn line" type="button">
                <img src="{% static 'icons/line.svg' %}">
            </button>
            <button id="google-login-btn" class="social-btn" type="button" >
                <img src="{% static 'icons/google.svg' %}">
            </button>
        </div>

        <div class="register-section">
            <h3>é‚„ä¸æ˜¯æœƒå“¡ï¼Ÿ</h3>
            <button class="register-btn" type="button" onclick="goToreRisterStep1()">
                è¨»å†Šæœƒå“¡
            </button>
        </div>
    </div>

    <!-- ================= è¨»å†Š ================= -->
    <div id="registerBox" class="form-box">

        <!-- è¨»å†Š Step 1 -->
        <div id="registerStep1" class="form-step active">
            <h1 class="login-title">è¨»å†Šæœƒå“¡</h1>

            <input class="login-input" type="text" id="regPhone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" required>
            <input class="login-input" type="email" id="regEmail" placeholder="Email" required>

            <button class="login-btn" type="button" onclick="goRegisterStep2()">
                ä¸‹ä¸€æ­¥
            </button>

            <div class="register-section">
                <h3>å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ</h3>
                <button class="register-btn" type="button" onclick="switchToLogin()">
                    ç™»å…¥
                </button>
            </div>
        </div>

        <!-- è¨»å†Š Step 2 -->
        <div id="registerStep2" class="form-step">
            <h1 class="login-title">è¨­å®šå¯†ç¢¼</h1>

            <form id="register-form" onsubmit="return false;">
                {% csrf_token %}
                <input class="login-input" name="password" type="password" placeholder="è¨­å®šå¯†ç¢¼(è‡³å°‘6ä½æ•¸)" minlength="6" required>
                <input class="login-input" name="password2" type="password" placeholder="ç¢ºèªå¯†ç¢¼(è‡³å°‘6ä½æ•¸)" minlength="6" required>

                <button class="login-btn" id="register-btn" type="button">å®Œæˆè¨»å†Š</button>
            </form>
        </div>
    </div>

    <!-- ================= å¿˜è¨˜å¯†ç¢¼ ================= -->
    <div id="forgotBox" class="form-box">

        <!-- å¿˜è¨˜å¯†ç¢¼ Step 1 -->
        <div id="forgotStep1" class="form-step active">
            <h1 class="login-title">å¿˜è¨˜å¯†ç¢¼</h1>

            <input class="login-input" id="forgotAccount" placeholder="è«‹è¼¸å…¥ Email æˆ–æ‰‹æ©Ÿ">

            <button class="login-btn" id="forgot-btn" type="button">
                ç™¼é€é©—è­‰ç¢¼
            </button>

            <div class="forgot-password" type="button" onclick="switchToLogin()">
                â† è¿”å›ç™»å…¥
            </div>
        </div>

        <!-- å¿˜è¨˜å¯†ç¢¼ Step 2 -->
        <div id="forgotStep2" class="form-step">
            <h1 class="login-title">è¼¸å…¥é©—è­‰ç¢¼</h1>

            <input class="login-input" id="forgotCode" placeholder="é©—è­‰ç¢¼">

            <button class="login-btn" id="forgot-confirm-btn">é©—è­‰</button>
        </div>

        <!-- å¿˜è¨˜å¯†ç¢¼ Step 3 -->
        <div id="resetPasswordBox" class="form-step">
            <h1 class="login-title">é‡è¨­å¯†ç¢¼</h1>

            <input class="login-input" id="newPwd" type="password" placeholder="æ–°å¯†ç¢¼">
            <input class="login-input" id="newPwd2" type="password" placeholder="ç¢ºèªæ–°å¯†ç¢¼">

            <button class="login-btn" id="reset-password-btn">ç¢ºèªé‡è¨­</button>
        </div>
    </div>
</div>
{% endblock content %}
{% block extra_js %}
<meta name="csrf-token" content="{{ csrf_token }}">
<script src="{% static 'js/auth-utils.js' %}"></script>
<script src="{% static 'js/login.js' %}"></script>
<script src="{% static 'js/register.js' %}"></script>
<script src="{% static 'js/forgot.js' %}"></script>

<!-- ğŸ”¥ğŸ”¥ğŸ”¥ åŠ åœ¨é€™è£¡ ğŸ”¥ğŸ”¥ğŸ”¥ -->
<script>
firebase.auth().onAuthStateChanged(async (user) => {
  if (!user) return;

  const token = await user.getIdToken();

  const res = await fetch("/api/firebase-login/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": document.querySelector(
        'meta[name="csrf-token"]'
      ).content,
    },
    body: JSON.stringify({ token }),
  });

  const data = await res.json();

  if (data.success) {
    window.location.replace("/GGshopping/");
  }
});
</script>

<script>
function showError(id, message) {
  const box = document.getElementById(id);
  if (!box) return;
  box.innerText = message;
  box.style.display = "flex";
}

function hideError(id) {
  const box = document.getElementById(id);
  if (!box) return;
  box.innerText = "";
  box.style.display = "none";
}

function firebaseErrorToMessage(err) {
  switch (err.code) {
    case "auth/user-not-found":
      return "æ­¤å¸³è™Ÿå°šæœªè¨»å†Š";
    case "auth/wrong-password":
      return "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥";
    case "auth/invalid-email":
      return "Email æ ¼å¼éŒ¯èª¤";
    case "auth/email-already-in-use":
      return "æ­¤ Email å·²è¢«è¨»å†Š";
    case "auth/weak-password":
      return "å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰";
    case "auth/invalid-credential":
      return "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
    case "auth/operation-not-allowed": 
      return "Firebase æœªå•Ÿç”¨ Google ç™»å…¥";
    case "auth/unauthorized-domain": 
      return "æ­¤ç¶²åŸŸæœªåœ¨ Firebase æˆæ¬Šæ¸…å–®ä¸­";
    case "auth/popup-closed-by-user": 
      return "ç™»å…¥è¦–çª—å·²è¢«é—œé–‰";
    case "auth/popup-closed-by-user":
      return "ç™»å…¥è¦–çª—å·²è¢«é—œé–‰ï¼Œè«‹é‡æ–°é»æ“Šä¸¦å®Œæˆç™»å…¥ã€‚";
    case "auth/popup-blocked":
      return "è«‹å…è¨±ç€è¦½å™¨å½ˆå‡ºè¦–çª—ï¼Œä»¥é€²è¡Œ Google ç™»å…¥ã€‚";
    default:
      return "æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
  }
}
</script>

<script>
function hideAllBoxes() {
  document.querySelectorAll(".form-box, .form-step").forEach(el => {
    el.classList.remove("active");
  });
}
function switchToLogin() {
  hideAllBoxes();
  document.getElementById("loginBox").classList.add("active");
}


function goToreRisterStep1() {
  hideAllBoxes();
  document.getElementById("registerBox").classList.add("active");
  document.getElementById("registerStep1").classList.add("active");
}

function goRegisterStep2() {
  document.getElementById("registerStep1").classList.remove("active");
  document.getElementById("registerStep2").classList.add("active");
}


function goToForgotStep1() {
  hideAllBoxes();
  document.getElementById("forgotBox").classList.add("active");
  document.getElementById("forgotStep1").classList.add("active");
}
</script>
{% endblock %}