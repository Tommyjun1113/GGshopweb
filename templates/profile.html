{% extends "GGshopping.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock head %}
{% block content %}
<div class="profile-layout">

  <!-- 側邊選單 -->
  <aside class="sidebar-profile-menu">
    <div class="menu-title">我的帳戶</div>
    <ul class="submenu">
      <li><a href="/profile/" class="active">我的帳戶</a></li>
      <li><a href="/orders/">購買紀錄</a></li>
      <li><a href="/favorites/">我的最愛</a></li>
    </ul>
  </aside>

  <!-- 會員資料 -->
  <section class="profile-card">
    <h2>會員資料</h2>

    <label>
        *使用者名稱
        <input id="name" type="text">
    </label>

     <label>
        *電子郵件
        <input id="email" type="email" disabled>
    </label>

    <label>
        手機號碼
        <input id="phone" type="text" >
    </label>
    <label >
        生日
        <input id="birthday" type="date" >
    </label>
    <label >
        性別
        <select id="gender">
            <option value="">請選擇</option>
            <option value="男">男</option>
            <option value="女">女</option>
            <option value="其他">其他</option>
        </select>
    </label>
    <label>
        地址
        <input id="address" type="text" >
    </label>
   

    <button id="saveProfile">儲存修改</button>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script>
/* ===============================
   載入會員資料
=============================== */
auth.onAuthStateChanged(async user => {
  if (!user) {
    location.href = "/login/";
    return;
  }

  const token = await user.getIdToken();
  const res = await fetch("/api/profile/", {
    headers: {
      Authorization: "Bearer " + token
    }
  });

  const data = await res.json();

  document.getElementById("name").value = data.name || "";
  document.getElementById("email").value = data.email || "";
  document.getElementById("phone").value = data.phone || "";
  document.getElementById("birthday").value = data.birthday || "";
  document.getElementById("gender").value = data.gender || "";
  document.getElementById("address").value = data.address || "";
});

/* ===============================
   儲存會員資料
=============================== */
document.getElementById("saveProfile").onclick = async () => {
  const user = auth.currentUser;
  if (!user) return;

  const token = await user.getIdToken();

  const body = {
    name: document.getElementById("name").value,
    phone: document.getElementById("phone").value,
    birthday: document.getElementById("birthday").value,
    gender: document.getElementById("gender").value,
    address: document.getElementById("address").value
  };

  const res = await fetch("/api/profile_update/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify(body)
  });

  if (res.ok) {
    const btn = document.getElementById("saveProfile");
    btn.innerText = "已儲存 ✔";
    setTimeout(() => btn.innerText = "儲存修改", 1500);
  } else {
    alert("更新失敗");
  }
};
</script>
{% endblock %}