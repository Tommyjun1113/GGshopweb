{% extends "GGshopping.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock head %}

{% block content %}
<h1 class="cart-title">è³¼ç‰©è»Š</h1>

<div id="cart-container" class="cart-container"></div>

<div id="cart-footer" class="cart-footer" style="display:none;">
  <div class="cart-footer-left">
    <a href="/shop/" class="cart-back">â† ç¹¼çºŒè³¼ç‰©</a>
  </div>

  <div class="cart-footer-right">
    <div class="cart-total">
      ç¸½é‡‘é¡ <span id="cart-total-price">NT$ 0</span>
    </div>
  </div>
</div>

<p id="cart-empty" class="cart-empty" style="display:none;">
  è³¼ç‰©è»Šæ˜¯ç©ºçš„
</p>
{% endblock content %}

{% block extra_js %}
<script>
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    window.location.href = "/login/";
    return;
  }

  const token = await user.getIdToken();

  const res = await fetch("/api/cart/", {
    headers: {
      Authorization: "Bearer " + token
    }
  });

  const cartItems = await res.json();
  console.log("ğŸ›’ cartItems =", cartItems);

  if (!cartItems.length) {
    document.getElementById("cart-empty").style.display = "block";
    return;
  }

  renderCart(cartItems);
});

function renderCart(items) {
  const container = document.getElementById("cart-container");
  const footer = document.getElementById("cart-footer");
  const totalEl = document.getElementById("cart-total-price");

  let total = 0;
  container.innerHTML = "";

  items.forEach(item => {
    const subtotal = item.price * item.quantity;
    total += subtotal;

    container.innerHTML += `
      <div class="cart-item">
        <div class="cart-img">
           <img src="/static/products/${item.imageKey}.png"
               alt="${item.productName}">
        </div>

        <div class="cart-info">
          <div class="cart-name">${item.productName}</div>
          <div class="cart-size">å°ºå¯¸ï¼š${item.size}</div>
        </div>

        <div class="cart-price">NT$ ${item.price}</div>
        <div class="cart-qty">${item.quantity}</div>
        <div class="cart-subtotal">NT$ ${subtotal}</div>
      </div>
    `;
  });

  totalEl.innerText = `NT$ ${total}`;
  footer.style.display = "flex";
}
</script>
{% endblock extra_js %}
