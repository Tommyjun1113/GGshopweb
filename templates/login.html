{% extends "GGshopping.html" %}
{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/login.css' %}">
{% endblock head %}

{% block content %}
<div class="login-container">

    {% if messages %}
      {% for message in messages %}
        <div class="msg {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- ================= ç™»å…¥ ================= -->
    <div id="loginBox" class="form-box active">
        <h1 class="login-title">ç™»å…¥</h1>
        <div id="login-error" class="login-error"></div>
       <form id="login-form" onsubmit="return false;">
            {% csrf_token %}

            <input
                class="login-input"
                type="text"
                name="account"
                placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"
                required
            >

            <input
                class="login-input"
                type="password"
                name="password"
                placeholder="è«‹è¼¸å…¥å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰"
                minlength="6"
                required
            >

            <button class="login-btn" id="email-login-btn" type="button">
                ç™»å…¥
            </button>
        </form>

        <div class="forgot-password" type="button" onclick="goToForgotStep1()">
            å¿˜è¨˜å¯†ç¢¼ï¼Ÿ
        </div>

        <div class="divider">æˆ–ä½¿ç”¨ç¤¾ç¾¤å¸³è™Ÿç™»å…¥</div>

        <div class="social-login">
            <button class="social-btn line" type="button">
                <img src="{% static 'icons/line.svg' %}">
            </button>
            <button id="google-login-btn" class="social-btn" type="button">
                <img src="{% static 'icons/google.svg' %}">
            </button>
        </div>

        <div class="register-section">
            <h3>é‚„ä¸æ˜¯æœƒå“¡ï¼Ÿ</h3>
            <button class="register-btn" type="button" onclick="goToreRisterStep1()">
                è¨»å†Šæœƒå“¡
            </button>
        </div>
    </div>

    <!-- ================= è¨»å†Š ================= -->
    <div id="registerBox" class="form-box">

        <!-- è¨»å†Š Step 1 -->
        <div id="registerStep1" class="form-step active">
            <h1 class="login-title">è¨»å†Šæœƒå“¡</h1>

            <input class="login-input" type="text" id="regPhone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" required>
            <input class="login-input" type="email" id="regEmail" placeholder="Email" required>

            <button class="login-btn" type="button" onclick="goRegisterStep2()">
                ä¸‹ä¸€æ­¥
            </button>

            <div class="register-section">
                <h3>å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ</h3>
                <button class="register-btn" type="button" onclick="switchToLogin()">
                    ç™»å…¥
                </button>
            </div>
        </div>

        <!-- è¨»å†Š Step 2 -->
        <div id="registerStep2" class="form-step">
            <h1 class="login-title">è¨­å®šå¯†ç¢¼</h1>

            <form id="register-form" onsubmit="return false;">
                {% csrf_token %}
                <input class="login-input" name="password" type="password" placeholder="è¨­å®šå¯†ç¢¼(è‡³å°‘6ä½æ•¸)" minlength="6" required>
                <input class="login-input" name="password2" type="password" placeholder="ç¢ºèªå¯†ç¢¼(è‡³å°‘6ä½æ•¸)" minlength="6" required>

                <button class="login-btn" id="register-btn" type="button">å®Œæˆè¨»å†Š</button>
            </form>
        </div>
    </div>

    <!-- ================= å¿˜è¨˜å¯†ç¢¼ ================= -->
    <div id="forgotBox" class="form-box">

        <!-- å¿˜è¨˜å¯†ç¢¼ Step 1 -->
        <div id="forgotStep1" class="form-step active">
            <h1 class="login-title">å¿˜è¨˜å¯†ç¢¼</h1>

            <input class="login-input" id="forgotAccount" placeholder="è«‹è¼¸å…¥ Email æˆ–æ‰‹æ©Ÿ">

            <button class="login-btn" id="forgot-btn" type="button" onclick="goForgotStep2()">
                ç™¼é€é©—è­‰ç¢¼
            </button>

            <div class="forgot-password" type="button" onclick="switchToLogin()">
                â† è¿”å›ç™»å…¥
            </div>
        </div>

        <!-- å¿˜è¨˜å¯†ç¢¼ Step 2 -->
        <div id="forgotStep2" class="form-step">
            <h1 class="login-title">è¼¸å…¥é©—è­‰ç¢¼</h1>

            <input class="login-input" id="forgotCode" placeholder="é©—è­‰ç¢¼">

            <button class="login-btn" id="forgot-confirm-btn">é©—è­‰</button>
        </div>

        <!-- å¿˜è¨˜å¯†ç¢¼ Step 3 -->
        <div id="resetPasswordBox" class="form-step">
            <h1 class="login-title">é‡è¨­å¯†ç¢¼</h1>

            <input class="login-input" id="newPwd" type="password" placeholder="æ–°å¯†ç¢¼">
            <input class="login-input" id="newPwd2" type="password" placeholder="ç¢ºèªæ–°å¯†ç¢¼">

            <button class="login-btn" id="reset-password-btn">ç¢ºèªé‡è¨­</button>
        </div>
    </div>
</div>
{% endblock content %}
{% block extra_js %}
<meta name="csrf-token" content="{{ csrf_token }}">

<script>
function showError(id, message) {
  const box = document.getElementById(id);
  if (!box) return;
  box.innerText = message;
  box.style.display = "flex";
}

function hideError(id) {
  const box = document.getElementById(id);
  if (!box) return;
  box.innerText = "";
  box.style.display = "none";
}

function firebaseErrorToMessage(err) {
  switch (err.code) {
    case "auth/user-not-found":
      return "æ­¤å¸³è™Ÿå°šæœªè¨»å†Š";
    case "auth/wrong-password":
      return "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥";
    case "auth/invalid-email":
      return "Email æ ¼å¼éŒ¯èª¤";
    case "auth/email-already-in-use":
      return "æ­¤ Email å·²è¢«è¨»å†Š";
    case "auth/weak-password":
      return "å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼ˆè‡³å°‘ 6 ç¢¼ï¼‰";
    case "auth/invalid-credential":
      return "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
    case "auth/operation-not-allowed": 
      return "Firebase æœªå•Ÿç”¨ Google ç™»å…¥";
    case "auth/unauthorized-domain": 
      return "æ­¤ç¶²åŸŸæœªåœ¨ Firebase æˆæ¬Šæ¸…å–®ä¸­";
    case "auth/popup-closed-by-user": 
      return "ç™»å…¥è¦–çª—å·²è¢«é—œé–‰";
    case "auth/popup-closed-by-user":
      return "ç™»å…¥è¦–çª—å·²è¢«é—œé–‰ï¼Œè«‹é‡æ–°é»æ“Šä¸¦å®Œæˆç™»å…¥ã€‚";
    case "auth/popup-blocked":
      return "è«‹å…è¨±ç€è¦½å™¨å½ˆå‡ºè¦–çª—ï¼Œä»¥é€²è¡Œ Google ç™»å…¥ã€‚";
    default:
      return "æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
  }
}
</script>

<script>
function hideAllBoxes() {
  document.querySelectorAll(".form-box, .form-step").forEach(el => {
    el.classList.remove("active");
  });
}


function switchToLogin() {
  hideAllBoxes();
  document.getElementById("loginBox").classList.add("active");
}


function goToreRisterStep1() {
  hideAllBoxes();
  document.getElementById("registerBox").classList.add("active");
  document.getElementById("registerStep1").classList.add("active");
}

function goRegisterStep2() {
  document.getElementById("registerStep1").classList.remove("active");
  document.getElementById("registerStep2").classList.add("active");
}


function goToForgotStep1() {
  hideAllBoxes();
  document.getElementById("forgotBox").classList.add("active");
  document.getElementById("forgotStep1").classList.add("active");
}

function goForgotStep2() {
  document.getElementById("forgotStep1").classList.remove("active");
  document.getElementById("forgotStep2").classList.add("active");
}
</script>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    /* ================= Firebase åˆå§‹åŒ– ================= */
   if (!firebase.apps.length) {
    firebase.initializeApp({
      apiKey: "AIzaSyDQIC_jH4wQguSTnvmy2gdl3TyJcO-lXME",
      authDomain: "shopping-54704.firebaseapp.com",
      projectId: "shopping-54704",
    });
  }

  const auth = firebase.auth();

  // 2ï¸âƒ£ ğŸ”” å”¯ä¸€æ­£ç¢ºå…¥å£ï¼šç­‰ Firebase å‘Šè¨´ä½ ç™»å…¥å®Œæˆ
  try {
    const result = await auth.getRedirectResult();

    if (result.user) {
      console.log("âœ… Redirect Firebase ç™»å…¥æˆåŠŸ:", result.user.email);

      const token = await result.user.getIdToken();

      const res = await fetch("/api/firebase-login/", {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector(
            'meta[name="csrf-token"]'
          ).content,
        },
        body: JSON.stringify({ token }),
      });

      const data = await res.json();
      console.log("ğŸ”¥ Django response:", data);

      if (data.success) {
        window.location.replace("/GGshopping/");
      }
    }
  } catch (err) {
    console.error("âŒ getRedirectResult error:", err);
  }
    
    /* ================= Email / å¯†ç¢¼ç™»å…¥ ================= */
    document.getElementById("email-login-btn").onclick = async () => {
    hideError("login-error");

    const emailInput = document.querySelector("input[name='account']");
    const passwordInput = document.querySelector("input[name='password']");
    
    emailInput.classList.remove("input-error");
    passwordInput.classList.remove("input-error");

    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
        showError("login-error", "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼");
        emailInput.classList.add("input-error");
        passwordInput.classList.add("input-error");
        return;
    }

    try {
        await auth.signInWithEmailAndPassword(email, password);
          const user = firebase.auth().currentUser;
          const token = await user.getIdToken();

          const res = await fetch("/api/firebase-login/", {
            method: "POST",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": document.querySelector(
                'meta[name="csrf-token"]'
              ).content,
            },
            body: JSON.stringify({ token }),
          });

          const data = await res.json();

          if (data.success) {
            window.location.replace("/GGshopping/");
          } else {
            alert("ç™»å…¥å¤±æ•—ï¼ˆå¾Œç«¯ï¼‰");
          }
      } catch (err) {
        showError("login-error", firebaseErrorToMessage(err));
        emailInput.classList.add("input-error");
        passwordInput.classList.add("input-error");
    }
  };

  /* ================= Google ç™»å…¥ ================= */
  document
    .getElementById("google-login-btn")
    .addEventListener("click", function () {
      console.log("ğŸ”¥ Google æŒ‰éˆ•é»æ“Š");
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });
      auth.signInWithRedirect(provider);
    });
  /* ================= LINE ç™»å…¥ ================= */
  const lineBtn = document.querySelector(".social-btn img[src*='line']")?.parentElement;
    if (lineBtn) { 
      lineBtn.addEventListener("click", () => {
        window.location.href = "/api/auth/line/login/";
      });
    }
});

</script>

<script>
document.getElementById("register-btn").onclick = async () => {
  const email = document.getElementById("regEmail").value.trim();
  const phone = document.getElementById("regPhone").value.trim();
  const password = document.querySelector("#registerStep2 input[name='password']").value;
  const password2 = document.querySelector("#registerStep2 input[name='password2']").value;

  if (!email || !phone || !password || !password2) {
    alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
    return;
  }

  if (password !== password2) {
    alert("å¯†ç¢¼ä¸ä¸€è‡´");
    return;
  }

  try {
   
    const cred = await firebase.auth()
      .createUserWithEmailAndPassword(email, password);

    const user = cred.user;

   
    await firebase.firestore()
      .collection("users")
      .doc(user.uid)
      .set({
        uid: user.uid,
        email: email,
        name: "",
        phone: phone,
        address: "",
        birthday: "",
        gender: "",
        provider: "password",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

    
    window.location.href = "/GGshopping/";

  } catch (e) {
    alert("è¨»å†Šå¤±æ•—ï¼š" + e.message);
  }
};
</script>


<script>

document.getElementById("forgot-btn").onclick = async () => {
  const email = document.getElementById("forgotAccount").value.trim();
  if (!email) {
    alert("è«‹è¼¸å…¥ Email");
    return;
  }

  const res = await fetch("/api/forgot/send-code/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });

  const data = await res.json();
  if (data.success) {
    document.getElementById("forgotStep1").classList.remove("active");
    document.getElementById("forgotStep2").classList.add("active");
  } else {
    alert(data.message || "Email ä¸å­˜åœ¨");
  }
};


document.getElementById("forgot-confirm-btn").onclick = async () => {
  const email = document.getElementById("forgotAccount").value.trim();
  const code = document.getElementById("forgotCode").value.trim();

  if (!code) {
    alert("è«‹è¼¸å…¥é©—è­‰ç¢¼");
    return;
  }

  const res = await fetch("/api/forgot/verify-code/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, code })
  });

  const data = await res.json();
  if (data.success) {
    document.getElementById("forgotStep2").classList.remove("active");
    document.getElementById("resetPasswordBox").classList.add("active");
  } else {
    alert("é©—è­‰ç¢¼éŒ¯èª¤");
  }
};


document.getElementById("reset-password-btn").onclick = async () => {
  const email = document.getElementById("forgotAccount").value.trim();
  const p1 = document.getElementById("newPwd").value.trim();
  const p2 = document.getElementById("newPwd2").value.trim();

  if (!p1 || !p2) {
    alert("è«‹è¼¸å…¥å¯†ç¢¼");
    return;
  }
  if (p1 !== p2) {
    alert("å¯†ç¢¼ä¸ä¸€è‡´");
    return;
  }

  const res = await fetch("/api/forgot/reset-password/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password: p1 })
  });

  const data = await res.json();
  if (data.success) {
    alert("å¯†ç¢¼é‡è¨­æˆåŠŸï¼Œè«‹é‡æ–°ç™»å…¥");
    switchToLogin();
  } else {
    alert("é‡è¨­å¤±æ•—");
  }
};
</script>

{% endblock %}